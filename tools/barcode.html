<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Generator & Reader</title>
    <script src="https://cdn.jsdelivr.net/npm/bwip-js@4/dist/bwip-js-min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #fff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .container {
            background: #232323;
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 480px;
        }
        h2 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #ccc;
        }
        .tabs {
            display: flex;
            background: #2a2a2a;
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 1.75rem;
        }
        .tab {
            flex: 1;
            padding: 0.6rem 0.75rem;
            border: none;
            background: none;
            color: #888;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .tab.active {
            background: #4a8cff;
            color: #fff;
        }
        .tab:not(.active):hover {
            color: #bbb;
        }
        .tab-icon {
            font-size: 0.8rem;
        }
        .section-divider {
            height: 1px;
            background: #333;
            margin: 1rem 0;
        }
        .panel {
            display: none;
        }
        .panel.active {
            display: block;
        }
        .option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .option-label {
            font-size: 0.9rem;
            color: #aaa;
            min-width: 60px;
        }
        select {
            flex: 1;
            padding: 8px 10px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            font-size: 0.9rem;
            outline: none;
            cursor: pointer;
        }
        select:focus {
            border-color: #4a8cff;
        }
        optgroup {
            color: #888;
            font-style: normal;
        }
        optgroup option {
            color: #fff;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px 12px;
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            color: #fff;
            font-size: 0.95rem;
            outline: none;
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
        }
        input[type="text"]:focus {
            border-color: #4a8cff;
        }
        input[type="text"]::placeholder {
            color: #666;
        }
        .preview-display {
            background: #fff;
            border-radius: 10px;
            padding: 1.25rem;
            text-align: center;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.25rem;
            overflow: hidden;
        }
        .preview-display canvas {
            max-width: 100%;
            height: auto;
        }
        .preview-placeholder {
            color: #999;
            font-size: 0.9rem;
        }
        .error-msg {
            color: #ff6b6b;
            font-size: 0.85rem;
            margin-top: -0.5rem;
            margin-bottom: 1rem;
            display: none;
        }
        .buttons {
            display: flex;
            gap: 12px;
        }
        .btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            border: 2px solid #4a8cff;
        }
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .btn-primary {
            background: #4a8cff;
            color: #fff;
        }
        .btn-primary:hover:not(:disabled) {
            background: #3a7aee;
        }
        .btn-outline {
            background: transparent;
            color: #4a8cff;
        }
        .btn-outline:hover:not(:disabled) {
            background: rgba(74, 140, 255, 0.1);
        }
        .btn.copied {
            background: #3a9a5c;
            border-color: #3a9a5c;
            color: #fff;
        }

        /* Read panel */
        .camera-section {
            margin-bottom: 1.25rem;
        }
        #camera-container {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
            display: none;
        }
        #camera-container video {
            width: 100%;
            display: block;
        }
        .camera-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 1rem;
        }
        .dropzone {
            width: 100%;
            min-height: 120px;
            border: 2px dashed #444;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 0.9rem;
            color: #888;
            cursor: pointer;
            padding: 1rem;
            margin-bottom: 1.25rem;
            transition: all 0.2s;
        }
        .dropzone:hover {
            border-color: #666;
            color: #aaa;
        }
        .dropzone.drag-over {
            border-color: #4a8cff;
            background: #2a2a2a;
            color: #fff;
        }
        input[type="file"] {
            display: none;
        }
        .result-box {
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 1.25rem;
            display: none;
        }
        .result-format {
            display: inline-block;
            background: #4a8cff;
            color: #fff;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 4px;
            margin-bottom: 0.75rem;
            text-transform: uppercase;
        }
        .result-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }
        .result-text {
            font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 1rem;
            word-break: break-all;
            line-height: 1.6;
            margin-bottom: 1rem;
            color: #fff;
        }
        .result-section {
            margin-bottom: 1rem;
        }
        .result-section:last-of-type {
            margin-bottom: 1rem;
        }
        .result-copy-btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border: 2px solid #4a8cff;
            background: transparent;
            color: #4a8cff;
            transition: all 0.15s;
        }
        .result-copy-btn:hover {
            background: rgba(74, 140, 255, 0.1);
        }
        .result-copy-btn.copied {
            background: #3a9a5c;
            border-color: #3a9a5c;
            color: #fff;
        }
        .read-error {
            color: #ff6b6b;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab active" data-panel="create">
                <span class="tab-icon">&#x2712;</span> Create
            </button>
            <button class="tab" data-panel="read">
                <span class="tab-icon">&#x1F4F7;</span> Read
            </button>
        </div>

        <!-- Create Panel -->
        <div id="panel-create" class="panel active">
            <h2>Barcode type</h2>
            <div class="section-divider"></div>
            <div class="option-row">
                <label class="option-label" for="barcode-type">Type</label>
                <select id="barcode-type">
                    <optgroup label="2D Codes">
                        <option value="qrcode" selected>QR Code</option>
                        <option value="datamatrix">Data Matrix</option>
                        <option value="datamatrixrectangular">Data Matrix Rectangular</option>
                        <option value="pdf417">PDF417</option>
                        <option value="azteccode">Aztec Code</option>
                    </optgroup>
                    <optgroup label="1D Product">
                        <option value="ean13">EAN-13</option>
                        <option value="ean8">EAN-8</option>
                        <option value="upca">UPC-A</option>
                        <option value="upce">UPC-E</option>
                        <option value="isbn">ISBN</option>
                    </optgroup>
                    <optgroup label="1D Industrial">
                        <option value="code128">Code 128</option>
                        <option value="code39">Code 39</option>
                        <option value="itf14">ITF-14</option>
                        <option value="interleaved2of5">Interleaved 2 of 5</option>
                        <option value="codabar">Codabar</option>
                    </optgroup>
                </select>
            </div>

            <h2>Data</h2>
            <div class="section-divider"></div>
            <div class="option-row">
                <label class="option-label" for="input-mode">Input</label>
                <select id="input-mode">
                    <option value="raw">Raw text</option>
                    <option value="escaped">Escaped (e.g. \u001d)</option>
                    <option value="gs1">GS1 human readable (e.g. (01)...)</option>
                </select>
            </div>
            <div style="margin-bottom: 1rem;">
                <input type="text" id="barcode-data" placeholder="Enter data to encode...">
            </div>
            <div class="error-msg" id="create-error"></div>

            <h2>Preview</h2>
            <div class="section-divider"></div>
            <div class="preview-display" id="preview-display">
                <span class="preview-placeholder">Enter data above to generate barcode</span>
            </div>

            <div class="buttons">
                <button class="btn btn-primary" id="btn-download" disabled>Download PNG</button>
                <button class="btn btn-outline" id="btn-copy-image" disabled>Copy image</button>
            </div>
        </div>

        <!-- Read Panel -->
        <div id="panel-read" class="panel">
            <h2>Camera</h2>
            <div class="section-divider"></div>
            <div class="camera-section">
                <div id="camera-container"></div>
                <div class="camera-buttons">
                    <button class="btn btn-primary" id="btn-camera-start">Start camera</button>
                    <button class="btn btn-outline" id="btn-camera-stop" style="display:none;">Stop</button>
                </div>
            </div>

            <h2>Upload image</h2>
            <div class="section-divider"></div>
            <input type="file" id="file-input" accept="image/*">
            <div class="dropzone" id="dropzone">
                Drop an image here, click to select, or paste from clipboard
            </div>
            <div class="read-error" id="read-error"></div>

            <h2>Result</h2>
            <div class="section-divider"></div>
            <div class="result-box" id="result-box">
                <div class="result-format" id="result-format"></div>
                <div class="result-section" id="human-section" style="display:none;">
                    <div class="result-label">Human readable</div>
                    <div class="result-text" id="result-human"></div>
                </div>
                <div class="result-section" id="escaped-section" style="display:none;">
                    <div class="result-label">Escaped</div>
                    <div class="result-text" id="result-escaped"></div>
                </div>
                <div class="result-section">
                    <div class="result-label" id="raw-label" style="display:none;">Raw</div>
                    <div class="result-text" id="result-text"></div>
                </div>
                <button class="result-copy-btn" id="btn-copy-result">Copy result</button>
            </div>
        </div>
    </div>

    <script>
        // --- State ---
        let currentCanvas = null;
        let html5QrCode = null;
        let cameraRunning = false;
        let debounceTimer = null;

        // --- Format metadata for placeholders and validation hints ---
        const FORMAT_INFO = {
            qrcode:           { placeholder: 'Any text, URL, etc.', freeform: true },
            datamatrix:       { placeholder: 'Any text or data', freeform: true },
            datamatrixrectangular: { placeholder: 'Any text or data', freeform: true },
            pdf417:           { placeholder: 'Any text or data', freeform: true },
            azteccode:        { placeholder: 'Any text or data', freeform: true },
            ean13:            { placeholder: '12 or 13 digits (e.g. 590123412345)', freeform: false },
            ean8:             { placeholder: '7 or 8 digits (e.g. 9638507)', freeform: false },
            upca:             { placeholder: '11 or 12 digits (e.g. 01234567890)', freeform: false },
            upce:             { placeholder: '7 or 8 digits (e.g. 0123456)', freeform: false },
            isbn:             { placeholder: '10 or 13 digit ISBN (e.g. 9781234567897)', freeform: false },
            code128:          { placeholder: 'Any ASCII text', freeform: true },
            code39:           { placeholder: 'A-Z, 0-9, - . $ / + % SPACE', freeform: true },
            itf14:            { placeholder: '13 or 14 digits', freeform: false },
            interleaved2of5:  { placeholder: 'Even number of digits', freeform: false },
            codabar:          { placeholder: 'Digits 0-9, - $ : / . +', freeform: true },
        };

        // --- Elements ---
        const barcodeTypeSelect = document.getElementById('barcode-type');
        const barcodeDataInput = document.getElementById('barcode-data');
        const previewDisplay = document.getElementById('preview-display');
        const createError = document.getElementById('create-error');
        const btnDownload = document.getElementById('btn-download');
        const btnCopyImage = document.getElementById('btn-copy-image');
        const btnCameraStart = document.getElementById('btn-camera-start');
        const btnCameraStop = document.getElementById('btn-camera-stop');
        const cameraContainer = document.getElementById('camera-container');
        const dropzone = document.getElementById('dropzone');
        const fileInput = document.getElementById('file-input');
        const readError = document.getElementById('read-error');
        const inputModeSelect = document.getElementById('input-mode');
        const resultBox = document.getElementById('result-box');
        const resultFormat = document.getElementById('result-format');
        const resultText = document.getElementById('result-text');
        const resultHuman = document.getElementById('result-human');
        const resultEscaped = document.getElementById('result-escaped');
        const humanSection = document.getElementById('human-section');
        const escapedSection = document.getElementById('escaped-section');
        const rawLabel = document.getElementById('raw-label');
        const btnCopyResult = document.getElementById('btn-copy-result');

        // --- Tab switching ---
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.getElementById('panel-' + tab.dataset.panel).classList.add('active');

                // Stop camera when switching away from read tab
                if (tab.dataset.panel !== 'read' && cameraRunning) {
                    stopCamera();
                }
            });
        });

        // --- Create: type change ---
        barcodeTypeSelect.addEventListener('change', () => {
            const info = FORMAT_INFO[barcodeTypeSelect.value];
            barcodeDataInput.placeholder = info.placeholder;
            generateBarcode();
        });

        // --- Create: input mode change ---
        inputModeSelect.addEventListener('change', generateBarcode);

        // --- Create: data input with debounce ---
        barcodeDataInput.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(generateBarcode, 150);
        });

        // --- Input parsing ---
        function parseEscaped(str) {
            return str.replace(/\\u([0-9a-fA-F]{4})/g, (_, hex) =>
                String.fromCharCode(parseInt(hex, 16))
            );
        }

        function parseGS1(str) {
            // Convert (AI)data notation to raw with GS separators
            const re = /\((\d{2,4})\)/g;
            let result = '';
            let lastIndex = 0;
            let match;
            let first = true;
            while ((match = re.exec(str)) !== null) {
                // Any text between AIs that isn't part of the pattern is stray â€” skip
                if (!first) {
                    result += '\u001d';
                }
                first = false;
                const ai = match[1];
                const afterAI = re.lastIndex;
                // Find the next AI or end of string
                const nextMatch = /\((\d{2,4})\)/.exec(str.substring(afterAI));
                const dataEnd = nextMatch ? afterAI + nextMatch.index : str.length;
                result += ai + str.substring(afterAI, dataEnd);
                re.lastIndex = dataEnd;
            }
            // If no AIs found, return as-is
            return result || str;
        }

        function resolveInput(raw) {
            const mode = inputModeSelect.value;
            if (mode === 'escaped') return parseEscaped(raw);
            if (mode === 'gs1') return parseGS1(raw);
            return raw;
        }

        function generateBarcode() {
            const rawInput = barcodeDataInput.value.trim();
            const data = resolveInput(rawInput);
            const bcType = barcodeTypeSelect.value;

            createError.style.display = 'none';
            createError.textContent = '';

            if (!data) {
                previewDisplay.innerHTML = '<span class="preview-placeholder">Enter data above to generate barcode</span>';
                currentCanvas = null;
                btnDownload.disabled = true;
                btnCopyImage.disabled = true;
                return;
            }

            try {
                const canvas = document.createElement('canvas');
                const is1D = !['qrcode', 'datamatrix', 'datamatrixrectangular', 'pdf417', 'azteccode'].includes(bcType);

                const opts = {
                    bcid: bcType,
                    text: data,
                    scale: 3,
                    backgroundcolor: 'FFFFFF',
                    padding: 5,
                };

                if (is1D) {
                    opts.height = 15;
                    opts.includetext = true;
                    opts.textxalign = 'center';
                }

                bwipjs.toCanvas(canvas, opts);

                previewDisplay.innerHTML = '';
                previewDisplay.appendChild(canvas);
                currentCanvas = canvas;
                btnDownload.disabled = false;
                btnCopyImage.disabled = false;
            } catch (e) {
                const msg = e.message || String(e);
                // Clean up bwip-js internal error messages
                const cleanMsg = msg.replace(/^bwip-js: /, '').replace(/^BWIPP /, '');
                createError.textContent = cleanMsg;
                createError.style.display = 'block';
                previewDisplay.innerHTML = '<span class="preview-placeholder">Invalid input for this format</span>';
                currentCanvas = null;
                btnDownload.disabled = true;
                btnCopyImage.disabled = true;
            }
        }

        // --- Create: download PNG ---
        btnDownload.addEventListener('click', () => {
            if (!currentCanvas) return;
            const link = document.createElement('a');
            link.download = barcodeTypeSelect.value + '-' + Date.now() + '.png';
            link.href = currentCanvas.toDataURL('image/png');
            link.click();
        });

        // --- Create: copy image ---
        btnCopyImage.addEventListener('click', async () => {
            if (!currentCanvas) return;
            try {
                const blob = await new Promise(resolve => currentCanvas.toBlob(resolve, 'image/png'));
                await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
                showCopied(btnCopyImage, 'Copy image');
            } catch {
                // Fallback: copy data URL as text
                try {
                    await navigator.clipboard.writeText(currentCanvas.toDataURL('image/png'));
                    showCopied(btnCopyImage, 'Copy image');
                } catch {
                    // Silently fail
                }
            }
        });

        function showCopied(btn, originalText) {
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('copied');
            }, 2000);
        }

        // --- Read: Camera ---
        btnCameraStart.addEventListener('click', startCamera);
        btnCameraStop.addEventListener('click', stopCamera);

        async function startCamera() {
            readError.style.display = 'none';
            cameraContainer.style.display = 'block';
            btnCameraStart.style.display = 'none';
            btnCameraStop.style.display = '';

            try {
                html5QrCode = new Html5Qrcode('camera-container');
                await html5QrCode.start(
                    { facingMode: 'environment' },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    () => {} // ignore scan failures
                );
                cameraRunning = true;
            } catch (e) {
                readError.textContent = 'Could not access camera: ' + (e.message || e);
                readError.style.display = 'block';
                cameraContainer.style.display = 'none';
                btnCameraStart.style.display = '';
                btnCameraStop.style.display = 'none';
                cameraRunning = false;
            }
        }

        async function stopCamera() {
            if (html5QrCode && cameraRunning) {
                try {
                    await html5QrCode.stop();
                } catch {}
                cameraRunning = false;
            }
            cameraContainer.style.display = 'none';
            btnCameraStart.style.display = '';
            btnCameraStop.style.display = 'none';
        }

        function onScanSuccess(decodedText, decodedResult) {
            const formatName = getFormatName(decodedResult.result.format?.formatName);
            showResult(formatName, decodedText);
        }

        // Auto-stop camera on page hide (battery saving)
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && cameraRunning) {
                stopCamera();
            }
        });

        // --- Read: File upload ---
        dropzone.addEventListener('click', () => fileInput.click());

        dropzone.addEventListener('dragover', e => {
            e.preventDefault();
            dropzone.classList.add('drag-over');
        });

        dropzone.addEventListener('dragleave', e => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
        });

        dropzone.addEventListener('drop', e => {
            e.preventDefault();
            dropzone.classList.remove('drag-over');
            if (e.dataTransfer.files[0]) {
                processUpload(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', e => {
            if (e.target.files[0]) processUpload(e.target.files[0]);
        });

        document.addEventListener('paste', e => {
            // Only handle paste when read tab is active
            if (!document.getElementById('panel-read').classList.contains('active')) return;
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.type.indexOf('image') !== -1) {
                    processUpload(item.getAsFile());
                    break;
                }
            }
        });

        async function processUpload(file) {
            readError.style.display = 'none';

            // Stop camera if running (mutual exclusion)
            if (cameraRunning) {
                await stopCamera();
            }

            try {
                const scanner = new Html5Qrcode('dropzone-scanner');
                const result = await scanner.scanFile(file, true);
                // scanFile only returns the text, not format info
                showResult('Detected', result);
                await scanner.clear();
            } catch (e) {
                readError.textContent = 'No barcode found in image. Try a clearer photo.';
                readError.style.display = 'block';
            }
        }

        // --- Read: Show result ---
        function showResult(format, text) {
            resultFormat.textContent = format;
            resultText.textContent = text;
            resultBox.style.display = 'block';

            const hasControl = /[\x00-\x1f]/.test(text);
            if (hasControl) {
                const human = toHumanReadable(text);
                resultHuman.textContent = human;
                humanSection.style.display = '';

                resultEscaped.textContent = toEscaped(text);
                escapedSection.style.display = '';

                rawLabel.style.display = '';
            } else {
                humanSection.style.display = 'none';
                escapedSection.style.display = 'none';
                rawLabel.style.display = 'none';
            }
        }

        function toEscaped(text) {
            let result = '';
            for (const ch of text) {
                const code = ch.charCodeAt(0);
                if (code < 0x20) {
                    result += '\\u' + code.toString(16).padStart(4, '0');
                } else {
                    result += ch;
                }
            }
            return result;
        }

        // --- GS1 AI length lookup ---
        function getAILength(digits) {
            const d2 = digits.substring(0, 2);
            const d3 = digits.substring(0, 3);

            // 4-digit AIs (check 3-char prefix)
            if (/^(31[0-6]|32[0-6]|33[0-6]|34[0-6]|35[0-6]|36[0-6]|390|391|392|393|394|395|421|423|425|700|701|702|703|704|710|711|712|713|714|723|800|801|802|810|811)/.test(d3)) return 4;
            // 3-digit AIs
            if (/^(240|241|242|243|250|251|253|254|255|400|401|402|403|410|411|412|413|414|415|416|417|420|422|424|426|427)/.test(d3)) return 3;
            // 2-digit AIs
            if (/^(00|01|02|10|11|12|13|15|16|17|20|21|22|30|37|90|91|92|93|94|95|96|97|98|99)/.test(d2)) return 2;
            // Default to 2
            return 2;
        }

        function toHumanReadable(text) {
            const GS = '\u001d';
            // GS1 data: convert to (AI)data notation
            if (text.indexOf(GS) !== -1) {
                let result = '';
                const raw = text.startsWith(GS) ? text.substring(1) : text;
                const segments = raw.split(GS);
                for (const seg of segments) {
                    if (!seg) continue;
                    const aiLen = getAILength(seg);
                    const ai = seg.substring(0, aiLen);
                    const data = seg.substring(aiLen);
                    result += '(' + ai + ')' + data;
                }
                return result || text;
            }

            // Non-GS1 data: show control char names
            let result = '';
            for (const ch of text) {
                const code = ch.charCodeAt(0);
                if (code < 0x20) {
                    const names = { 0: 'NUL', 1: 'SOH', 2: 'STX', 3: 'ETX', 4: 'EOT', 5: 'ENQ', 6: 'ACK', 7: 'BEL', 8: 'BS', 9: 'TAB', 10: 'LF', 11: 'VT', 12: 'FF', 13: 'CR', 14: 'SO', 15: 'SI', 16: 'DLE', 17: 'DC1', 18: 'DC2', 19: 'DC3', 20: 'DC4', 21: 'NAK', 22: 'SYN', 23: 'ETB', 24: 'CAN', 25: 'EM', 26: 'SUB', 27: 'ESC', 28: 'FS', 29: 'GS', 30: 'RS', 31: 'US' };
                    result += '<' + (names[code] || '0x' + code.toString(16).padStart(2, '0')) + '>';
                } else {
                    result += ch;
                }
            }
            return result;
        }

        function getFormatName(raw) {
            if (!raw) return 'Detected';
            const map = {
                'QR_CODE': 'QR Code',
                'DATA_MATRIX': 'Data Matrix',
                'PDF_417': 'PDF417',
                'AZTEC': 'Aztec',
                'EAN_13': 'EAN-13',
                'EAN_8': 'EAN-8',
                'UPC_A': 'UPC-A',
                'UPC_E': 'UPC-E',
                'CODE_128': 'Code 128',
                'CODE_39': 'Code 39',
                'CODE_93': 'Code 93',
                'ITF': 'ITF',
                'CODABAR': 'Codabar',
                'RSS_14': 'RSS-14',
                'RSS_EXPANDED': 'RSS Expanded',
            };
            return map[raw] || raw;
        }

        // --- Read: Copy result ---
        btnCopyResult.addEventListener('click', async () => {
            const text = resultText.textContent;
            try {
                await navigator.clipboard.writeText(text);
                showCopied(btnCopyResult, 'Copy result');
            } catch {
                const ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                showCopied(btnCopyResult, 'Copy result');
            }
        });

        // --- Init ---
        barcodeDataInput.placeholder = FORMAT_INFO[barcodeTypeSelect.value].placeholder;
    </script>
    <!-- Hidden element for file scanning -->
    <div id="dropzone-scanner" style="display:none;"></div>
</body>
</html>
